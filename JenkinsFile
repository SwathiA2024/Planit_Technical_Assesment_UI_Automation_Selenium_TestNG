pipeline {
  agent any
  options { timestamps() }
  tools { jdk 'temurin-17'; maven 'Maven 3.9.x' }

  parameters {
    choice(name: 'browser', choices: ['', 'chrome', 'firefox'], description: 'Override browser (blank = use testng.xml)')
    booleanParam(name: 'headless', defaultValue: true, description: 'Run headless in CI')
    string(name: 'suiteFile', defaultValue: 'testng.xml', description: 'Path to TestNG suite')
  }

  stages {
    stage('Checkout') { steps { checkout scm } }
    stage('Build & Test') {
      steps {
        script {
          def props = ["-Dsurefire.suiteXmlFiles=${params.suiteFile}", "-Dheadless=${params.headless}"]
          if (params.browser?.trim()) props << "-Dbrowser=${params.browser.trim()}"
          def propsLine = props.join(' ')
          if (isUnix()) {
            sh """
              java -version || true
              if [ -x ./mvnw ]; then ./mvnw -B -U -V clean test ${propsLine}
              else mvn -B -U -V clean test ${propsLine}; fi
            """
          } else {
            bat """
              java -version
              if exist mvnw.cmd (
                .\\mvnw.cmd -B -U -V clean test ${propsLine}
              ) else (
                mvn -B -U -V clean test ${propsLine}
              )
            """
          }
        }
      }
    }
  }

  post {
    always {
      junit 'target/surefire-reports/*.xml'
      publishHTML(target: [
        reportDir: 'test-output',
        reportFiles: 'ExtentReport.html',
        reportName: 'Automation Test Report',
        keepAll: true, alwaysLinkToLastBuild: true, allowMissing: true
      ])
      archiveArtifacts artifacts: 'target/surefire-reports/**/*, test-output/**/*, screenshots/**/*', allowEmptyArchive: true
    }
  }
}
